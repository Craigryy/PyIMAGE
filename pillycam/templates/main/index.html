{% extends "account/base.html" %}
{% load static %}

{% block content %}
<div class="column">
    {% include "main/navbar.html" %}
</div>

<div class="dashboard-container">
    <br/>
    <br/>
    <div class="container">
        <br/>
        <br/>
        <h2>Your Photo Board</h2>

        {% if images %}
            <div class="photo-board">
                {% for image in images %}
                    <div class="photo">
                        <img src="{{ image.thumbnail.url }}" alt="Thumbnail" class="select-image" data-image-path="{{ image.image.url }}">
                        <p>Uploaded on: {{ image.created_on }}</p>
                        <p>{{ image.title }}</p>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No photos uploaded yet.</p>
        {% endif %}
    </div>

    <h1>Image Effects</h1>

    <!-- Form for image upload -->
    <form id="uploadForm" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="file" name="image" accept="image/*" id="imageInput" required>
        <select name="effect">
            <option value="brightness">Brightness</option>
            <option value="grayscale">Grayscale</option>
            <option value="blackwhite">Black & White</option>
            <option value="sepia">Sepia</option>
            <option value="contrast">Contrast</option>
            <option value="blur">Blur</option>
            <option value="findedges">Find Edges</option>
            <option value="bigenhance">Edge Enhance (More)</option>
            <option value="enhance">Edge Enhance</option>
            <option value="smooth">Smooth (More)</option>
            <option value="emboss">Emboss</option>
            <option value="contour">Contour</option>
            <option value="sharpen">Sharpen</option>
        </select>
        <button type="button" id="applyEffect">Apply Effect</button>
        <button type="submit">Upload and Save</button>
    </form>

    <div id="imageContainer">
        <h2>Processed Image</h2>
        <img id="processedImage" alt="Processed Image">
        <!-- Placeholder for uploaded image (adjust according to your structure) -->
        <img id="uploadedImage" alt="Uploaded Image">
    </div>

    <!-- Placeholder for delete button (adjust according to your structure) -->
    <button class="delete-button" data-image-id="1">Delete Image 1</button>

    <button type="button" class="btn btn-primary" id="openDisplayModal">Open Display Modal</button>
</div>

{% include "main/display_modal.html" %}

<script>
    // Function to handle image selection
    $(".select-image").click(function () {
        var imagePath = $(this).data("image-path");
        $("#processedImage").attr("src", imagePath);
    });

    $("#applyEffect").click(function () {
        var selectedEffect = $("select[name='effect']").val();
        var imageInput = document.getElementById("imageInput");
        var processedImage = document.getElementById("processedImage");

        // Create a new FormData object
        var formData = new FormData();
        formData.append('image', imageInput.files[0]);
        formData.append('effect', selectedEffect);

        // Make an AJAX request to apply the effect
        $.ajax({
            url: "{% url 'main:image' %}",
            type: "post",
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                processedImage.src = data;
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
                alert("Error applying effect. Check the console for more information.");
            }
        });
    });

    // Function to upload and save the image
    $("#uploadForm").submit(function (e) {
        e.preventDefault();

        $.ajax({
            url: "{% url 'main:home' %}",  // Use the correct URL name
            type: "post",
            data: new FormData(this),
            processData: false,
            contentType: false,
            success: function (data) {
                // Display the uploaded image
                $("#uploadedImage").attr("src", data);
                // Clear the processed image
                $("#processedImage").attr("src", "");
            },
            error: function () {
                alert("Error uploading image.");
            }
        });
    });

    // Function to open the display modal
    $("#openDisplayModal").click(function () {
        $("#displayModal").modal("show");
    });

    // Function to delete the image
    $(".delete-button").click(function () {
        var imageId = $(this).data("image-id");

        $.ajax({
            url: "{% url 'main:delete' id=0 %}".replace('0', imageId),  // Use the correct URL name
            type: "get",
            success: function () {
                // Refresh the page or update the UI as needed
                location.reload();
            },
            error: function () {
                alert("Error deleting image.");
            }
        });
    });
</script>

<!-- Link to CSS file -->
<link rel="stylesheet" type="text/css" href="{% static 'css/dashboard.css' %}">

{% endblock %}
